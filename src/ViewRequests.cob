>>SOURCE FORMAT FREE
IDENTIFICATION DIVISION.
PROGRAM-ID. ViewRequests.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
       SELECT PENDING-REQUESTS-FILE ASSIGN TO "data/PendingRequests.dat"
           ORGANIZATION IS INDEXED
           ACCESS MODE IS DYNAMIC
           RECORD KEY IS REQUEST-ID
           FILE STATUS IS LS-PENDING-REQUESTS-STAT.
       
       SELECT ESTABLISHED-CONNECTIONS-FILE ASSIGN TO "data/EstablishedConnections.dat"
           ORGANIZATION IS SEQUENTIAL
           ACCESS MODE IS SEQUENTIAL
           FILE STATUS IS LS-ESTABLISHED-CONNECTIONS-STAT.

       SELECT PROFILE-FILE ASSIGN TO "data/profiles.dat"
           ORGANIZATION IS LINE SEQUENTIAL
           FILE STATUS IS LS-PROFILE-FILE-STAT.

DATA DIVISION.
FILE SECTION.
FD PENDING-REQUESTS-FILE.
01 PENDING-REQUESTS-RECORD.
       05 REQUEST-ID PIC 99.
       05 SENDER-USERNAME PIC X(30).
       05 RECIPIENT-USERNAME PIC X(30).

FD ESTABLISHED-CONNECTIONS-FILE.
01 ESTABLISHED-CONNECTIONS-RECORD.
       05 CONNECTION-USER-ONE PIC X(30).
       05 CONNECTION-USER-TWO PIC X(30).

FD PROFILE-FILE.
01 PROFILE-RECORD.
    05 PROFILE-USERNAME    PIC X(30).
    05 PROFILE-NAME        PIC X(50).
    05 PROFILE-UNIVERSITY  PIC X(50).
    05 PROFILE-MAJOR       PIC X(50).
    05 PROFILE-GRADYEAR    PIC 9(4).
    05 PROFILE-ABOUT       PIC X(200).
    05 PROFILE-JOBTITLE    OCCURS 3 TIMES PIC X(50).
    05 PROFILE-COMPANY     OCCURS 3 TIMES PIC X(50).
    05 PROFILE-DATES       OCCURS 3 TIMES PIC X(30).
    05 PROFILE-DESC        OCCURS 3 TIMES PIC X(200).
    05 PROFILE-DEGREE      OCCURS 3 TIMES PIC X(50).
    05 PROFILE-UNIV        OCCURS 3 TIMES PIC X(50).
    05 PROFILE-YEARS       OCCURS 3 TIMES PIC X(30).

LOCAL-STORAGE SECTION.
*> File Status
01 LS-PENDING-REQUESTS-STAT        PIC XX.
01 LS-ESTABLISHED-CONNECTIONS-STAT PIC XX.
01 LS-PROFILE-FILE-STAT            PIC XX.
01 LS-EOF                          PIC X  VALUE "N".
01 LS-FOUND-INFO                   PIC X  VALUE "N".
*> Request Count
01 LS-MAX_REQUESTS                 PIC 99 VALUE 25.
01 LS-REQUEST-COUNT                PIC 99 VALUE 0.
*> Request Array
01 RECEIVED-REQUESTS               PIC X(30) OCCURS 0 TO 25 TIMES DEPENDING ON LS-REQUEST-COUNT.
01 REQUEST-INDEX                   PIC 99.
*> Misc.
01 LS-NO-LEADING-ZEROS             PIC ZZ.
01 LS-NAME-TO-LOOKUP               PIC X(30).
01 LS-OPTION-SELECTION             PIC 9.

LINKAGE SECTION.
01 LNK-USER-NAME                   PIC X(30).

PROCEDURE DIVISION USING LNK-USER-NAME.

MAIN.
       DISPLAY "--- Pending Connection Requests ---"
       OPEN I-O PENDING-REQUESTS-FILE

      *> Open File
       EVALUATE LS-PENDING-REQUESTS-STAT
           WHEN "00"
               CONTINUE
           WHEN "35"
               CLOSE PENDING-REQUESTS-FILE
               OPEN OUTPUT PENDING-REQUESTS-FILE
               CLOSE PENDING-REQUESTS-FILE
               OPEN I-O PENDING-REQUESTS-FILE
           WHEN OTHER
               DISPLAY "Error Opening PendingRequests.dat: " LS-PENDING-REQUESTS-STAT
               CLOSE PENDING-REQUESTS-FILE
               GOBACK
       END-EVALUATE

      *> Get lowest key
       MOVE 0 TO REQUEST-ID
       START PENDING-REQUESTS-FILE KEY >= REQUEST-ID
           INVALID KEY
               MOVE "Y" TO LS-EOF
       END-START

      *> Iterate through file to get
       PERFORM UNTIL LS-EOF = "Y"
           IF LNK-USER-NAME = RECIPIENT-USERNAME
               ADD 1 TO LS-REQUEST-COUNT
               MOVE SENDER-USERNAME TO RECEIVED-REQUESTS(LS-REQUEST-COUNT)
               DELETE PENDING-REQUESTS-FILE
           END-IF 
           
           READ PENDING-REQUESTS-FILE NEXT RECORD
               AT END MOVE "Y" TO LS-EOF
           END-READ
       END-PERFORM
       CLOSE PENDING-REQUESTS-FILE
       
       IF LS-REQUEST-COUNT = 0
           DISPLAY "You have no pending connection requests at this time."
           DISPLAY "-----------------------------------"
           GOBACK
       END-IF
       
       DISPLAY "People who want to connect:"
       PERFORM VARYING REQUEST-INDEX FROM 1 BY 1 UNTIL REQUEST-INDEX > LS-REQUEST-COUNT
           MOVE RECEIVED-REQUESTS(REQUEST-INDEX) TO LS-NAME-TO-LOOKUP
           PERFORM PULL-PROFILE-DATA
       END-PERFORM
       DISPLAY "-----------------------------------"
       GOBACK.

PULL-PROFILE-DATA.
       MOVE "N" TO LS-EOF
       MOVE "N" TO LS-FOUND-INFO
       OPEN INPUT PROFILE-FILE
       PERFORM UNTIL LS-EOF = "Y" OR LS-FOUND-INFO = "Y"
           READ PROFILE-FILE
               AT END
                   MOVE "Y" TO LS-EOF
               NOT AT END
                   IF FUNCTION TRIM(LS-NAME-TO-LOOKUP) IS EQUAL TO FUNCTION TRIM(PROFILE-USERNAME)
                       MOVE "Y" TO LS-FOUND-INFO
                   END-IF
           END-READ
       END-PERFORM

       CLOSE PROFILE-FILE

       IF LS-EOF = "Y" AND LS-FOUND-INFO = "N"
           DISPLAY "Could not retrieve sender data"
           GOBACK
       END-IF

       DISPLAY "Request from:" FUNCTION TRIM(PROFILE-NAME)
       DISPLAY "1. Accept"
       DISPLAY "2. Reject"
       DISPLAY "Enter your choice for " FUNCTION TRIM(PROFILE-NAME) ":"
       ACCEPT LS-OPTION-SELECTION
       DISPLAY FUNCTION TRIM(LS-OPTION-SELECTION)

       PERFORM WITH TEST BEFORE UNTIL LS-OPTION-SELECTION = 1 OR LS-OPTION-SELECTION = 2
           DISPLAY "Invalid Choice"
           DISPLAY "Request from: " FUNCTION TRIM(PROFILE-NAME)
           DISPLAY "1. Accept"
           DISPLAY "2. Reject"
           ACCEPT LS-OPTION-SELECTION
           DISPLAY "Enter your choice for " FUNCTION TRIM(PROFILE-NAME) ": "
       END-PERFORM
       
       IF LS-OPTION-SELECTION = 1
           DISPLAY "Connection request from " FUNCTION TRIM(PROFILE-NAME) " accepted!"
           OPEN EXTEND ESTABLISHED-CONNECTIONS-FILE

           EVALUATE LS-ESTABLISHED-CONNECTIONS-STAT
           WHEN "00"
               CONTINUE
           WHEN "35"
               CLOSE ESTABLISHED-CONNECTIONS-FILE
               OPEN OUTPUT ESTABLISHED-CONNECTIONS-FILE
               CLOSE ESTABLISHED-CONNECTIONS-FILE
               OPEN EXTEND ESTABLISHED-CONNECTIONS-FILE
           WHEN OTHER
               DISPLAY "Error Opening data/EstablishedConnections.dat: " LS-PENDING-REQUESTS-STAT
               CLOSE ESTABLISHED-CONNECTIONS-FILE
               GOBACK
           END-EVALUATE

           MOVE SPACES TO CONNECTION-USER-ONE
           MOVE SPACES TO CONNECTION-USER-TWO

           MOVE LNK-USER-NAME TO CONNECTION-USER-ONE
           MOVE PROFILE-USERNAME TO CONNECTION-USER-TWO

           WRITE ESTABLISHED-CONNECTIONS-RECORD

           CLOSE ESTABLISHED-CONNECTIONS-FILE
       ELSE
           DISPLAY "Connection request from " FUNCTION TRIM(PROFILE-NAME) " rejected!"
       END-IF.
